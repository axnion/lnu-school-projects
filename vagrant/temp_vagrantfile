# -*- mode: ruby -*-
# vi: set ft=ruby :

config.vm.provision :shell, privileged: false, inline: <<-SHELL
    gpg --keyserver hkp://keys.gnupg.net --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3
    curl -sSL https://get.rvm.io | bash -s stable
    source ~/.rvm/scripts/rvm

    rvm install 2.3.1
    rvm use 2.3.1 --default
    gem install bundler
SHELL



# Adding ubuntu user and databse to Postgres
config.vm.provision :shell, privileged: false, inline: <<-SHELL
    echo 'Adding ubuntu user and databse to Postgres'
    sudo -u postgres createuser --superuser ubuntu
    sudo -u postgres createdb ubuntu
SHELL

# Installing rbenv
config.vm.provision :shell, privileged: false, inline: <<-SHELL
    echo 'Installing Rbenv'
    git clone https://github.com/rbenv/rbenv.git ~/.rbenv
    git clone https://github.com/rbenv/ruby-build.git ~/.rbenv/plugins/ruby-build

    RBENV_PATH='export PATH="$HOME/.rbenv/bin:$PATH"'
    echo $RBENV_PATH >> ~/.bash_profile
    RBENV_INIT='eval "$(rbenv init -)"'
    echo $RBENV_INIT >> ~/.bash_profile
SHELL

# Installing Ruby 2.3.1
config.vm.provision :shell, privileged: false, inline: <<-SHELL
    echo 'Installing Ruby 2.3.1'
    rbenv install 2.3.1
    rbenv global 2.3.1
SHELL

# Installing Bundler
config.vm.provision :shell, privileged: false, inline: <<-SHELL
    echo 'Installing Bundler'
    gem install bundler
SHELL








config.vm.provision :shell, privileged: false, inline: <<-SHELL
    wget https://github.com/ysbaddaden/prax.cr/releases/download/v0.6.0/prax_0.6.0-1_amd64.deb
    sudo dpkg -i prax_0.6.0-1_amd64.deb
    mkdir ~/.prax

    cd /vagrant/hours
    prax link
SHELL




















# Installing prax
config.vm.provision :shell, privileged: false, inline: <<-SHELL
    git clone https://github.com/ysbaddaden/prax.cr.git

    echo 'Installing the NSSWitch extension'
    cd ~/prax.cr/ext
    make
    sudo make install

    echo 'Installing the iptables rules'
    cd ~/prax.cr
    sudo cp install/debian/initd /etc/init.d/prax
    sudo update-rc.d prax defaults
    #sudo /etc/init.d/prax start

    echo 'Instaling prax'
    make
    make CRYSTAL_BIN=/opt/crystal/bin/crystal
    mkdir ~/.prax

    cd /vagrant/Hours
    prax link

    echo 'Starting prax'
    cd ~/prax.cr
    ./bin/prax start
SHELL
