---
  - hosts: localhost
    vars_prompt:
      - name: "username"
        prompt: "Openstack Username"
      - name: "password"
        prompt: "Openstack Password"

    tasks:
      - name: Create network
        os_network:
          auth:
            auth_url: https://labcloudftk2.lnu.se:5000
            username: "{{ username }}"
            password: "{{ password }}"
            project_name: Group01_project
          name: testnet
          state: present
          external: false

      - name: Create subnet
        os_subnet:
          auth:
            auth_url: https://labcloudftk2.lnu.se:5000
            username: "{{ username }}"
            password: "{{ password }}"
            project_name: Group01_project
          name: testsubnet
          state: present
          network_name: testnet
          cidr: 10.0.10.0/24
          dns_nameservers:
            - 194.47.199.41
            - 194.47.110.97

      - name: Create router
        os_router:
          auth:
            auth_url: https://labcloudftk2.lnu.se:5000
            username: "{{ username }}"
            password: "{{ password }}"
            project_name: Group01_project
          name: routis
          state: present
          network: internetlan
          interfaces:
            - testsubnet

      - name: Create security group ssh
        os_security_group:
          auth:
            auth_url: https://labcloudftk2.lnu.se:5000
            username: "{{ username }}"
            password: "{{ password }}"
            project_name: Group01_project
          name: ssh
          state: present
          description: Security group for allowing incomming ssh connections

      - name: Add SSH rule to security group ssh
        os_security_group_rule:
          auth:
            auth_url: https://labcloudftk2.lnu.se:5000
            username: "{{ username }}"
            password: "{{ password }}"
            project_name: Group01_project
          security_group: ssh
          protocol: tcp
          port_range_min: 22
          port_range_max: 22
          remote_ip_prefix: 0.0.0.0/0

      - name: Create a machine
        os_server:
          state: present
          auth:
            auth_url: https://labcloudftk2.lnu.se:5000
            username: "{{ username }}"
            password: "{{ password }}"
            project_name: Group01_project
          name: testVM
          image: ba7be78b-9986-4631-9242-c7d87540b50f
          flavor: cpu1-ram512-disk5
          network: testnet
          key_name: cloud
          auto_ip: true
          security_groups: default,ssh
